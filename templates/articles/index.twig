
{% set entryQuery = craft.entries().section('article') %}
{% set entries = entryQuery.all() %}


{% include 'components/html_head.twig' with {'css': 'articles'} %}
{% include 'components/navbar.twig' %}

{% cache for 3 weeks %}
<section class="posts dark grid">
    <div class="heading">
        <h2>TrailLog Posts</h2>
    </div>
    <div class="wide">
        <p class="trail_log_intro">
            Connect with nature, get some fresh air, find yourself, and have fun. Take the extra step (or 10,000) and join us on one of the thousands of backcountry trails the country has to offer!
        </p>
    </div>

    <div class="wide">
        <div class="trail_log_menu">
            <button class="filter_option active">Most Recent</button>
            <button class="filter_option">Region</button>
            <button class="filter_option">Park</button>
            <button class="filter_option difficulty">Difficulty</button>
            <button class="filter_option">Recreation</button>
        </div>
    </div>

    {%- set entryQuery = craft.entries().section('article').orderBy('postDate desc') -%} {#.limit(9)#}
    {%- set entries = entryQuery.all() -%}
    <div class="sm_container"  style="display: contents">
    <div class="recent_articles sm">
        {%- for entry in entries -%}
            <a href="{{entry.url}}" class="article">
                <div class="article_image" style="background-image: url({{ get_image_from_media(entry.heroImage, 800, 450) }})"></div>
                <div class="metadata">
                    {% if entry.place %}<div class="location">{{ entry.place }}</div>{% endif %}
                    <div class="title">{{entry.title}}</div>
                </div>
            </a>
        {%- endfor -%}
    </div>
    </div>
    <div class="md_container" style="display: contents">
    {% set section = "" %}
    <div class="recent_articles md">
    {%- for entry in entries -%}
        {%- set month =  entry.postDate.format("F") -%}
    {% if section is not same as(month) %}
        </div>
        <h3 class="wide">{{ month }}</h3>
        <hr class="wide"/>
        <div class="recent_articles md">
        {% set section = month %}
    {% endif %}
            {%- set month = entry.postDate.format("F") -%}
            <div class="article">
                <a href="{{entry.url}}">
                    <div class="article_image" style="background-image: url({{ get_image_from_media(entry.heroImage, 800, 450) }})">
                    {% if entry.place %}<div class="location">{{ entry.place }}</div>{% endif %}
                    </div>
                </a>
                <div class="title"><a href="{{entry.url}}">{{entry.title}}</a></div>
                <a href="{{entry.url}}" class="read_more">Read More</a>
            </div>
    {%- endfor -%}
    </div>
    </div>

</section>
<script>
    var sm = document.querySelector('.sm_container');
    var md = document.querySelector('.md_container');
    document.querySelectorAll('.filter_option.difficulty').forEach(function(e){
      e.addEventListener('click',function(e){
        document.querySelectorAll('.filter_option').forEach(function(e){e.classList.remove('active')});
        e.target.classList.add('active');

        var xhr = new XMLHttpRequest();
        xhr.open('GET', '/api/articles?category=difficulty');
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.onload = function() {
          if (xhr.status === 200) {
            var data = JSON.parse(xhr.responseText);
            console.log(data);

            var sm_result = "";
            var md_result = "";

            for(var i = 0; i < data.length; i++){
              var category = data[i];
              console.log({category});
              var category_title = category.title;
              var category_articles = category.articles;

              md_result += `
                <h3 class="wide">${ category_title }</h3>
                <hr class="wide"/>
                <div class="recent_articles md">
              `;
              category_articles.forEach(function(e){
                md_result += `
                  <div class="article">
                    <div class="article_image" style="background-image: url(${e.thumb })"></div>
                    <div class="title">${e.title}</div>
                    <a href="${e.url}" class="read_more">Read More</a>
                </div>
                `
              });
              md_result+= '</div>'

            }
            console.log(md_result);
            sm.innerHTML = sm_result;
            md.innerHTML = md_result;


          }
        };
        xhr.send();
      })
    })
</script>
{% include 'components/footer.twig' %}
{% endcache %}