{% set article = craft.entries().id(entry.id).with([
    'heroImage',
    'articleAuthor'
]).one()%}

{% include 'components/html_head.twig' with {'css': 'article', 'title': article.title} %}
{% include 'components/navbar.twig' %}
<body>
<main id="swup" class="__article__">
    {% if article.heroImage | length > 0 %}
        <style>
            .loadingPlaceholder{
            background-image: url({{ get_image_from_media(article.heroImage, 50) }})
            }

            .heroImage {
                background-image: url({{ get_image_from_media(article.heroImage, 1920) }})
            }
            @media screen and (min-width: 1920px) {
                .heroImage {
                    background-image: url({{ get_image_from_media(article.heroImage, 1440) }})
                }
            }
            @media screen and (min-width: 1440px) {
                .heroImage {
                    background-image: url({{ get_image_from_media(article.heroImage, 2560) }})
                }
            }
            @media screen and (min-width: 2560px) {
                .heroImage {
                    background-image: url({{ get_image_from_media(article.heroImage, 3840) }})
                }
            }
            @media screen and (min-width: 3840px) {
                .heroImage {
                    background-image: url({{ get_image_from_media(article.heroImage, 3840) }})
                }
            }
        </style>
    {% endif %}


    {% set story = 0 %}
    {% set found = 0 %}
    {% set story_chapter_number = 0 %}


    {% set storySearch = craft.entries().section('story').search('chapterList:' ~ article.title).with(['chapterList']).all() %}
    {%  if storySearch | length > 0 %}
        {% set found = 1 %}
        {% set story = storySearch[0] %}
        {% set chapters = story.chapterList %}
        {% set story_length = chapters | length %}
        {% set story_chapter_number = 0 %}
        {% for chapter in story.chapterList %}
            {% if chapter.slug == article.slug %}
                {% set story_chapter_number = loop.index0 %}
            {% endif %}
        {% endfor %}
    {% endif %}
    <section class="head grid">
        <div class="title_block">
            <h1 class="slide_transition">
                {{article.title}}
            </h1>

            {% if article.place != "NA" %}
                <div class="caption slide_transition" >{{article.place}}</div>
            {% endif %}

            {% if article.articleAuthor | length > 0 %}
                <div class="author_block fade_transition" data-delay="1.2s">
                    <div class="image" style="background-image: url({{ get_image_from_media(article.articleAuthor[0].image, 300, 300) }})"></div>
                    <div class="info">
                        <div data-xlink="/author/{{article.articleAuthor[0].slug}}">Article by {{article.articleAuthor[0].title}}</div>
                        <div>{{(article.articleDate  ?? article.postDate) | date("F d, Y")}}</div>
                    </div>
                </div>
            {% endif %}
        </div>

        {% if article.heroImage | length == 1 %}
          <div class="heroImageContainer">
            <div class="heroImage"></div>
            <div class="loadingPlaceholder"></div>
          </div>
        {% endif %}

        <div class="article_info">
            <div class="blurb_and_chapters">
                <div class="blurb">
                    {{article.description ? article.description : ''}}
                </div>

                {% if found %}
                    <div class="chapters">
                        <div class="title">{{story.title}}</div>
                        <div class="chapter-nav">
                            {% if story_chapter_number > 0 %}
                                <a href="{{chapters[story_chapter_number - 1].url}}">
                                    <span class="sr-only">Previous Article</span>
                                    <i class="arrow left primary"></i>
                                </a>
                            {% else %}
                                <a disabled>
                                    <span class="sr-only">Disabled, No Previous Article</span>
                                    <i class="arrow left disabled"></i>
                                </a>
                            {% endif %}
                            <div class='chapter_display'>{{ story_chapter_number + 1 }} / {{ story_length }}</div>
                            {% if story_chapter_number < story_length - 1 %}
                                <a href="{{chapters[story_chapter_number+1].url}}">
                                    <span class="sr-only">Next Article</span>
                                    <i class="arrow right primary"></i>
                                </a>
                            {% else %}
                                <a disabled>
                                    <span class="sr-only">Disabled, No Next Article</span>
                                    <i class="arrow right disabled"></i>
                                </a>
                            {% endif %}
                        </div>
                    </div>
                {% endif %}

            </div>
            {% if article.showTrailInfo %}
                <div class="stat_display">
                    <input id="show_stats" type="checkbox"/>
                    <label for="show_stats" class="caption primary"> Trail Info</label>
                    <div class="stats">
                        {% if article.miles %}<div class="stat_block"><div class="title">Miles</div><div class="caption primary">{{article.miles}}</div></div>{% endif %}
                        {% if article.days %}<div class="stat_block"><div class="title">Days</div><div class="caption primary">{{article.days}}</div></div>{% endif %}
                        {% if article.difficulty %}<div class="stat_block"><div class="title">Difficulty</div><div class="caption primary">{{article.difficulty}}</div></div>{% endif %}
                        {% if article.trailType %}<div class="stat_block"><div class="title">Trail</div><div class="caption primary">{{article.trailType}}</div></div>{% endif %}

                        {% if article.camping %}<div class="stat_block"><div class="title">Camping</div><div class="caption primary">{{article.camping}}</div></div>{% endif %}
                        {% if article.month %}<div class="stat_block"><div class="title">Month</div><div class="caption primary">{{article.month}}</div></div>{% endif %}
                        {% if article.parkType %}<div class="stat_block"><div class="title">Park Type</div><div class="caption primary">{{article.parkType}}</div></div>{% endif %}
                        {% if article.traffic %}<div class="stat_block"><div class="title">Traffic</div><div class="caption primary">{{article.traffic}}</div></div>{% endif %}
                    </div>
                </div>
            {% endif %}

        </div>
    </section>

    <section class="story grid">
        <div class="text-size-picker">
            <button class='option small_text'>A <span class="sr-only">Change text size: small</span></button>
            <button class='option regular_text'>A <span class="sr-only">Change text size: medium</span></button>
            <button class='option large_text'>A <span class="sr-only">Change text size: large</span></button>
        </div>

        <article>
            {% for block in article.mainContent.with(['image:image']).all() %}
                {% if block.type == "paragraph" %}

                    {{ block.textMarkdown|markdown }}

                {% elseif block.type == "blockQuote" %}
                    <blockquote>
                        {{ block.quote | markdown }}
                        <footer>{{ block.author }}</footer>
                    </blockquote>

                {% elseif block.type == "sectionTitle" %}

                    <h2>{{block.text}}</h2>

                {% elseif block.type == "image" %}
                    <figure class="single_image {{block.imageSize ? block.imageSize:''}}">

                        {% set sizes = '100vw' %}
                        {% if block.imageSize %}
                            {% if block.imageSize == 'align-center' %}
                                {% set sizes = '(max-width: 900px) 100vw, 800px' %}
                            {% elseif block.imageSize == 'align-half' %}
                                {% set sizes = '(max-width: 900px) 100vw, 1400px' %}
                            {% endif %}
                        {% endif %}
                        {% set srcset = get_srcset_from_media(block.image, [600,800,1400,1920,2560,3840]) %}
                        <img src="{{get_image_from_media(block.image, 1920)}}"
                             sizes="{{ sizes }}"
                             srcset="{{ srcset }}"
                             alt="{{ block.image[0].description ?? ""}}">
                        <figcaption class="{{block.captionLocation}} {{block.imageSize ? block.imageSize:''}}"> {{ block.caption }}</figcaption>
                    </figure>

                {% elseif block.type == "caltopoMap" %}
                    <figure class="caltopo_map {{block.size ? block.size:''}}">
                        <iframe src="https://caltopo.com/m/{{block.mapCode}}"></iframe>
                    </figure>


                {% elseif block.type == "list" %}
                    <ul>
                        {% for row in block.list %}
                            <li>{{ row.item }}</li>
                        {% endfor %}
                    </ul>

                {% elseif block.type == "youtubeVideo" %}
                    <div
                            class="video youtube_video {{block.videoSize ? block.videoSize:''}}"
                            data-id="video_{{ loop.index }}"
                            data-videos="{% for row in block.videos %}{{ row.videoID }},{{ row.startTime }},{{ row.playbackSpeed }};{% endfor %}"
                            data-settings="{{ block.videoOptions.contains('showControls') ? '1':'0' }},{{ block.videoOptions.contains('startMuted') ? '1':'0' }},{{ block.videoOptions.contains('autoPlay') ? '1':'0' }},{{ block.videoOptions.contains('loop') ? '1':'0' }}"
                    >
                        <div id="video_{{ loop.index }}" style="width:100%"></div>
                    </div>
                    <script></script>
                {% elseif block.type == "doubleImage" %}
                    <div class="double_image">
                        {% set sizes = '50vw' %}
                        {% if block.imageSize %}
                            {% if block.imageSize == 'align-center' %}
                                {% set sizes = '(max-width: 900px) 50vw, 400px' %}
                            {% elseif block.imageSize == 'align-half' %}
                                {% set sizes = '(max-width: 900px) 50vw, 700px' %}
                            {% endif %}
                        {% endif %}

                        {% set srcset = get_srcset_from_media(block.imageOne, [600,800,1400,1920,2560,3840]) %}
                        <img src="{{ get_image_from_media(block.imageOne, 1920) }}"
                             sizes="{{ sizes }}"
                             srcset="{{ srcset }}">

                        {% set srcset = get_srcset_from_media(block.imageTwo, [600,800,1400,1920,2560,3840]) %}

                        <img src="{{ get_image_from_media(block.imageTwo, 1920) }}"
                             sizes="{{ sizes }}"
                             srcset="{{ srcset }}">
                    </div>
                {% endif %}


            {% endfor %}
        </article>
    </section>
    <section class="read_more grid dark">
      {% if found and story_chapter_number < story_length - 1 %}
        {% set nextArticle = craft.entries().section('article').id(chapters[story_chapter_number+1].id).with(['heroImage']).first() %}
      {% else %}
          {% set nextArticle = craft.entries().section('article').with(['heroImage']).orderBy('random()').limit(1).first() %}
      {% endif %}


        <a class="next_story" href="{{ nextArticle.url }}">

          <div class="story_info">
            <hr/>
            <span class="caption">
              {% if found and  story_chapter_number < story_length - 1 %}
                Read the next chapter ( {{ story_chapter_number + 2 }} / {{ story_length }} )
              {% else %}
                Keep reading
              {% endif %}

              <h1  class="hover_color title">{{ nextArticle.title }}</h1>
              <p>{{ nextArticle.description }}</p>

            </span>
          </div>
          <div>
            <div
                class="image hover_border"
                style="background-image: url({{ get_image_from_media(article.heroImage, 500) }})">
            </div>
          </div>

        </a>

        <div class="scroll_to_top">
            <!--suppress HtmlUnknownAnchorTarget -->
            <a class="primary_button" href="#top" onclick="return scroll_to_top(event)">
              <span>Back to top</span>
            </a>
        </div>
        <div class="clearfix"></div>
    </section>



    {% include 'components/share.twig' %}
    {% include 'components/footer.twig' %}
    <script>
        (function(){
            const size_picker = document.querySelector('.story .text-size-picker');
            const article = document.querySelector('.story article');
            size_picker.querySelector('.small_text').addEventListener('click', function(){
                article.classList.add('small_text');
                article.classList.remove('large_text');
            });
            size_picker.querySelector('.regular_text').addEventListener('click', function(){
                article.classList.remove('small_text');
                article.classList.remove('large_text');
            });
            size_picker.querySelector('.large_text').addEventListener('click', function(){
                article.classList.remove('small_text');
                article.classList.add('large_text');
            });
        })()
    </script>
</main>
</body>